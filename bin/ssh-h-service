#!/bin/sh -e
##:
#h: Usage: ssh-h-service [OPS...] MACHINE:s=SERVICE ...
#h:
#h: Manage services in remote machines.
#h:
#h:   -D : Get init system.
#h:   -T : Print tail of service logs. [-c tail]
#h:
#h:   -v : View service status. [-c status]
#h:   -e : Enable services.     [-c enable]
#h:   -r : Restart services.    [-c restart]
#h:   -s : Start service.       [-c start]
#h:   -p : Stop service.        [-c stop]
#h:
##:
. argdb
ssh_h_service() {
    local OPTIND optopt ssh srv mng ret=0 cmd=
    
    ## Parse command line arguments.
    while getopts "DvrspeTc:" optopt; do
        case $optopt in
            D)  cmd="init"      ;;
            v)  cmd="status"    ;;
            r)  cmd="restart"   ;;
            e)  cmd="enable"    ;;
            s)  cmd="start"     ;;
            p)  cmd="stop"      ;;
            T)  cmd="tail"      ;;
            c)  cmd="${OPTARG}" ;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))

    ## Print help.
    if test ! -n "${cmd}"; then
        printf '%-10s %s\n' "SERVER" "SERVICE"
        for ssh in $(argdb -l "$@"); do
            for srv in $(argdb -i "${ssh}" -p s "$@"); do
                printf '%-10s %s\n' "${ssh}" "${srv}"
            done
        done
        echo ""
        echo "COMMANDS:"
        echo ""
        echo "... enable  : Enable service."
        echo "... status  : View service status."
        echo "... restart : Restart all the services."
        echo "... start   : Start all the services."
        echo "... stop    : Stop all the services."
        echo "... tail    : View the tail of services."
        echo ""
        return 0
    fi
    
    ## Operations.
    for ssh in $(argdb -l "$@" | sort -u); do
        mng="$(ssh_h_initd)"
        test -n "${mng}"
        case "${cmd}" in
            init)
                echo "${mng}"
                ;;
            status|restart|start|stop|tail|enable)
                for srv in $(argdb -i "${ssh}" -p s "$@"); do
                    echo "${ssh}: ${mng} ${cmd} ${srv}"
                    if ! ssh_h_"${mng}"_"${cmd}"; then
                        ret=1
                    fi
                done
                ;;
        esac
        echo ""
    done
    
    ## Return
    return "${ret}"
}
ssh_h_initd() {
    ssh_h_service_run '
        if which sv >/dev/null 2>&1; then
            echo runit
        elif which systemctl >/dev/null 2>&1; then
            echo systemd
        else
            echo >&2 "error: Unknown service manager."
            exit 0
        fi'
}
## -------------------------------------------------------------------
ssh_h_runit_status()  { ssh_h_service_run "sudo sv status  ${srv}"; }
ssh_h_runit_restart() { ssh_h_service_run "sudo sv restart ${srv}"; }
ssh_h_runit_start()   { ssh_h_service_run "sudo sv start   ${srv}"; }
ssh_h_runit_stop()    { ssh_h_service_run "sudo sv down    ${srv}"; }
ssh_h_runit_tail()    { ssh_h_service_run "tail -n 40 /var/log/${srv}.log"; }
ssh_h_runit_enable() {
    ssh_h_service_run "
        if test ! -e /var/service/${srv}; then
            sudo ln -s /etc/sv/iberiar /var/service/${srv}
        fi"
}
## -------------------------------------------------------------------
ssh_h_systemd_status()  { ssh_h_service_run "sudo systemctl status  ${srv} | cat"; }
ssh_h_systemd_restart() { ssh_h_service_run "sudo systemctl restart ${srv}"; }
ssh_h_systemd_start()   { ssh_h_service_run "sudo systemctl start   ${srv}"; }
ssh_h_systemd_stop()    { ssh_h_service_run "sudo systemctl stop    ${srv}"; }
ssh_h_systemd_tail()    { ssh_h_service_run "tail -n 40 /var/log/${srv}.log"; }
## -------------------------------------------------------------------
ssh_h_service_run() {
    
    case "${ssh}" in
        localhost) sh -e -c "$*";;
        *)         ssh "${ssh}" "set -e; $*";;
    esac
}

## -------------------------------------------------------------------
if test @"$(basename "$0")" = @"ssh-h-service";then
    case "${1}" in
        ''|-h|--help) sed -n 's/^ *#h: \{0,1\}//p' "$0" ;;
        *)            ssh_h_service "$@";;
    esac
fi
#echo "X Restarting..."
#ssh m1 sudo sv restart iberiar
